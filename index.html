<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=5, user-scalable=yes">
    <link rel="icon" type="image/x-icon" href="./icons/favicon.ico">
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
    <link rel="manifest" href="./manifest.json">
    <title>WebGAL - 网页端视觉小说引擎</title>
    <style>
        :root {
            --target-width: 2560px;
            --target-height: 1440极;
            --primary-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --transition-duration: 1s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            font-family: '思源宋体', 'Source Han Serif', 'Noto Serif CJK SC', 'SimSun', Georgia, serif;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        .effect-background {
            height: 100vh;
            width: 100vw;
            filter: blur(50px);
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .title-screen {
            width: var(--target-width);
            height: var(--target-height);
            overflow: hidden;
            position: absolute;
           极: 0;
            z-index: 14;
            opacity: 1;
            transition: opacity 1.5s;
            cursor: pointer;
        }

        .initial-bg {
            height: 100%;
            width: 100%;
            position: absolute;
            background: var(--primary-gradient);
            top: 0;
            opacity: 1;
            transition: opacity var(--transition-duration);
        }

        .white-overlay {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            opacity: 0;
            background: linear-gradient(
                165deg,
                rgba(255, 255, 255, 0.25) 0%,
                rgba(255, 255, 255, 1) 50%,
                rgba(255, 255, 255, 0.25) 100%
            );
            transition: opacity极(--transition-duration);
        }

        .title-content {
            width: 100%;
            position: absolute;
            top: 0;
            height: 100%;
            opacity: 极;
            font-size: 175%;
            transition: opacity var(--transition-duration);
            z-index: 15;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .main-title {
            letter-spacing: 0.25em;
            padding: 2em;
            text-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            transition: text-shadow var(--transition-duration);
            font-size: 175%;
            animation: title-blinking 4s infinite;
            text-align: center;
        }

        @keyframes title-blinking {
            0% { text-shadow: 0 0 15px rgba(0, 0, 0, 0.65); }
            50% { text-shadow: 0 极 15px rgba(255, 255, 255, 0.5); }
            100% { text-shadow: 0 0 15px rgba(0, 0, 0, 0.65); }
        }

        .credit {
            position: absolute;
            bottom: 1em;
            color: #666;
            font-size: 75%;
            display: flex;
            justify-content: center;
            width: 100%;
            flex-flow: column;
            align-items: center;
        }

        .credit div {
            padding-bottom: 0.25em;
        }

        .credit a {
            color: #4a86e8;
            text-decoration: none;
            font-weight: bold;
        }

        .credit a:hover {
            text-decoration: underline;
        }

        #panic-overlay, #root {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* 错误覆盖层 */
        #error-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            z-index: 9999;
            padding: 20px;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        #error-overlay h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }

        #error-overlay p {
            margin-bottom: 30px;
            font-size: 16px;
            max-width: 80%;
        }

        #error-overlay button {
            padding: 12px 24px;
            background: #4a86e8;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        #error-overlay button:hover {
            background: #3a76d8;
        }

        /* 加载状态指示器 */
        .loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 9999;
            display: none;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .main-title {
                font-size: 140%;
                padding: 1.5em;
            }
        }

        @media (max-width: 480px) {
            .main-title {
                font-size: 120%;
                padding: 1em;
            }
            
            .credit {
                font-size: 60%;
            }
        }
    </style>
</head>
<body>
    <!-- 错误覆盖层 -->
    <div id="error-overlay">
        <h2>加载遇到问题</h2>
        <p id="error-message"></p>
        <button onclick="location.reload()">重新加载页面</button>
    </div>
    
    <!-- 加载状态指示器 -->
    <div class="loading-indicator" id="loadingIndicator">
        加载中，请稍候...
    </div>
    
    <!-- 安全加载CSS -->
    <link rel="stylesheet" href="./assets/index-52a967b4.css" onerror="console.warn('CSS加载失败，但页面仍可运行')">
    
    <!-- 背景模糊 -->
    <div class="effect-background"></div>
    
    <!-- 标题屏幕 -->
    <div class="title-screen">
        <div class="initial极"></div>
        <div class="white-overlay"></div>
        <div class="title-content">
            <div class="main-title">PRESS THE SCREEN TO START</div>
            <div class="credit">
                <div>Powered by <a href="https://github.com/OpenWebGAL/WebGAL" target="_blank">WebGAL</a> Framework</div>
            </div>
        </div>
    </div>
    
    <!-- 紧急回避页挂载点 -->
    <div id="panic-overlay"></div>
    
    <!-- 应用挂载点 -->
    <div id="root"></div>

    <script>
        // 全局错误处理
        window.addEventListener('error', function(e) {
            console.warn('捕获到全局错误:', e.message, e.filename);
            showError('页面加载遇到问题: ' + (e.message || '未知错误'));
        });

        // 显示错误信息
        function showError(message) {
            const errorOverlay = document.getElementById('error-overlay');
            const errorMessage = document.getElementById('error-message');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            
            if (errorOverlay && errorMessage) {
                errorMessage.textContent = message;
                errorOverlay.style.display = 'flex';
            }
        }

        // 安全包装有问题的函数
        function safeWrapProblematicFunctions() {
            // 检查并包装可能出问题的函数
            if (window.Je && typeof window.Je.flushChunk === 'function') {
                const originalFlushChunk = window.Je.flushChunk;
                
                window.Je.flushChunk = function(s) {
                    try {
                        // 确保s是有效的DOM元素且有hasAttribute方法
                        if (s && typeof s.hasAttribute === 'function') {
                            return originalFlushChunk.call(this, s);
                        } else {
                            console.warn('无效的DOM元素传递给flushChunk:', s);
                            return null;
                        }
                    } catch (e) {
                        console.error('flushChunk执行出错:', e);
                        return null;
                    }
                };
            }
        }

        // 修复后的初始化代码
        (function() {
            // 显示加载指示器
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
            }
            
            // 检测iOS设备
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            // 响应式调整函数
            function adjustLayout() {
                const targetWidth = 2560;
                const targetHeight = 1440;
                
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                
                const scaleX = windowWidth / targetWidth;
                const scaleY = windowHeight / targetHeight;
                const scale = Math.min(scaleX, scaleY);
                
                const translateX = (windowWidth - targetWidth * scale) / 2;
                const translateY = (windowHeight - targetHeight * scale) / 2;
                
                const elementsToScale = [
                    document.querySelector('.title-screen'),
                    document.querySelector('#root')
                ].filter(el => el !== null);
                
                elementsToScale.forEach(el => {
                    el.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
                    el.style.transformOrigin = 'top left';
                });
                
                // 背景效果单独处理
                const effectBg = document.querySelector('.effect-background');
                if (effectBg) {
                    effectBg.style.transform = `scale(${1/scale})`;
                    effectBg.style.transformOrigin = 'center';
                }
            }
            
            // 初始化事件监听
            function initEvents() {
                const titleScreen = document.querySelector('.title-screen');
                
                if (titleScreen) {
                    titleScreen.addEventListener('click', enterEngine);
                }
                
                // GitHub链接特殊处理
                const githubLink = document.querySelector('.credit a');
                if (githubLink) {
                    githubLink.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                }
                
                window.addEventListener('resize', adjustLayout);
            }
            
            // 进入引擎主界面
            function enterEngine() {
                const initialBg = document.querySelector('.initial-bg');
                const titleContent = document.querySelector('.title-content');
                const whiteOverlay = document.querySelector('.white-overlay');
                const titleScreen = document.querySelector('.title-screen');
                
                if (initialBg) initialBg.style.opacity = '0';
                if (titleContent) titleContent.style.op极 = '0';
                
                setTimeout(() => {
                    if (whiteOverlay) whiteOverlay.style.opacity = '1';
                }, 50);
                
                setTimeout(() => {
                    if (titleScreen) {
                        titleScreen.style.opacity = '0';
                        titleScreen.style.pointerEvents = 'none';
                    }
                }, 500);
                
                setTimeout(()极 {
                    if (titleScreen) titleScreen.style.display = 'none';
                }, 2000);
                
                // 触发引擎加载
                if (window.enterPromiseResolve) {
                    window.enterPromiseResolve();
                }
            }
            
            // 安全加载主脚本
            function loadMainScript() {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.type = 'module';
                    script.crossOrigin = 'anonymous';
                    script.src = './assets/index-7326e954.js';
                    
                    script.onload = function() {
                        console.log('主脚本加载成功');
                        // 尝试包装有问题的函数
                        setTimeout(safeWrapProblematicFunctions, 100);
                        
                        if (loadingIndicator) {
                            loadingIndicator.style.display = 'none';
                        }
                        resolve();
                    };
                    
                    script.onerror = function(e) {
                        console.warn('主脚本加载失败:', e);
                        showError('主脚本加载失败，请检查网络连接或刷新页面');
                        reject(new Error('主脚本加载失败'));
                    };
                    
                    document.head.appendChild(script);
                });
            }
            
            // 页面加载完成后初始化
            window.addEventListener('load', function() {
                try {
                    adjustLayout();
                    initEvents();
                    
                    // 尝试加载主脚本
                    loadMainScript().catch(e => {
                        console.warn('主脚本加载失败，但页面基本功能仍可用:', e);
                    });
                    
                    // 初始化Service Worker
                    if ('serviceWorker' in navigator && !isIOS) {
                        navigator.serviceWorker.register('./webgal-serviceworker.js')
                            .then(reg => console.log('SW registered: ', reg))
                            .catch(err => console.log('SW registration failed: ', err));
                    }
                } catch (error) {
                    showError('初始化失败: ' + error.message);
                }
            });
            
            // 暴露enterEngine函数以便其他脚本调用
            window.enterEngine = enterEngine;
        })();
    </script>
    
    <!-- 加载IIFE插件 - 修复版本 -->
    <script>
        (function() {
            const loadScript = (url, type) => {
                return new Promise((resolve, reject) => {
                    // 确保url是字符串
                    if (typeof url !== 'string') {
                        reject(new Error('URL must be a string'));
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = url;
                    if (type) script.type = type;
                    
                    // 添加错误处理
                    script.onload = () => {
                        console.log(`Loaded: ${url}`);
                        resolve(url);
                    };
                    
                    script.onerror = (e) => {
                        console.warn(`Failed to load: ${url}`, e);
                        reject(new Error(`Failed to load: ${url}`));
                    };
                    
                    document.head.appendChild(script);
                });
            };
            
            const loadIifePlugin = async (pluginPath) => {
                try {
                    // 确保路径有效
                    if (!plugin极 || typeof pluginPath !== 'string') {
                        console.warn('Invalid plugin path:', pluginPath);
                        return false;
                    }
                    
                    await loadScript(pluginPath);
                    return true;
                } catch (error) {
                    console.warn('Plugin loading error:', error);
                    return false;
                }
            };
            
            // 安全地加载Live2D SDK
            try {
                const live2d2Promise = loadIifePlugin('lib/live2d.min.js');
                const live2d4Promise = loadIifePlugin('lib/live2dcubismcore.min.js');
                
                window.live2dPromise = Promise.allSettled([live2d2Promise, live2d4Promise])
                    .then(results => {
                        console.log('Live2D loading results:', results);
                        return results;
                    });
            } catch (error) {
                console.warn('Live2D initialization error:', error);
                window.live2dPromise = Promise.resolve([]);
            }
        })();
    </script>
</body>
</html>
